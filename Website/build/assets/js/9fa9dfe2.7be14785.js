"use strict";(self.webpackChunkclassic=self.webpackChunkclassic||[]).push([[1311],{7740:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>d});var i=r(4848),t=r(8453);const s={sidebar_position:1},a="Aquaware API and Arduino",o={id:"real-world-example/Arduino",title:"Aquaware API and Arduino",description:"Introduction",source:"@site/docs/real-world-example/Arduino.md",sourceDirName:"real-world-example",slug:"/real-world-example/Arduino",permalink:"/docs/real-world-example/Arduino",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"realWorldSidebar"},l={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Hardware and Software Requirements",id:"hardware-and-software-requirements",level:3},{value:"Libraries Used",id:"libraries-used",level:3},{value:"Setting Up the Environment",id:"setting-up-the-environment",level:2},{value:"Wiring the Sensors",id:"wiring-the-sensors",level:2},{value:"Initialization",id:"initialization",level:2},{value:"WiFi Setup",id:"wifi-setup",level:3},{value:"Sensor Initialization",id:"sensor-initialization",level:3},{value:"Authentication Handling in the Arduino Code",id:"authentication-handling-in-the-arduino-code",level:2},{value:"1. <code>login()</code>: Getting Access and Refresh Tokens",id:"1-login-getting-access-and-refresh-tokens",level:3},{value:"Key Steps in the <code>login()</code> Function",id:"key-steps-in-the-login-function",level:4},{value:"Code Example",id:"code-example",level:4},{value:"2. <code>refreshAccessToken()</code>: Maintaining an Active Session",id:"2-refreshaccesstoken-maintaining-an-active-session",level:3},{value:"Key Steps in the <code>refreshAccessToken()</code> Function",id:"key-steps-in-the-refreshaccesstoken-function",level:4},{value:"Code Example",id:"code-example-1",level:4},{value:"Best Practices for Authentication",id:"best-practices-for-authentication",level:3},{value:"Sending Sensor Data to the Aquaware API",id:"sending-sensor-data-to-the-aquaware-api",level:2},{value:"Breakdown of the <code>sendData()</code> Function",id:"breakdown-of-the-senddata-function",level:3},{value:"Code Example",id:"code-example-2",level:3},{value:"Best Practices for Data Transmission",id:"best-practices-for-data-transmission",level:3},{value:"Error Handling",id:"error-handling",level:3},{value:"Main Loop Explanation in the Arduino Code",id:"main-loop-explanation-in-the-arduino-code",level:2},{value:"Polling vs. Timer-Based Approach",id:"polling-vs-timer-based-approach",level:3},{value:"Timer Configuration in the Loop",id:"timer-configuration-in-the-loop",level:3},{value:"Code Example for the <code>loop()</code> Function",id:"code-example-for-the-loop-function",level:3},{value:"Explanation of Sensor Reading Functions",id:"explanation-of-sensor-reading-functions",level:3},{value:"1. Reading Temperature (<code>readTemp()</code>)",id:"1-reading-temperature-readtemp",level:4},{value:"2. Reading pH (<code>readPH()</code>)",id:"2-reading-ph-readph",level:4},{value:"Handling <code>READINGSCOUNT</code>",id:"handling-readingscount",level:3},{value:"Best Practices",id:"best-practices",level:3},{value:"Complete Code",id:"complete-code",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"aquaware-api-and-arduino",children:"Aquaware API and Arduino"})}),"\n",(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"This tutorial demonstrates how to use an Arduino to collect water quality data (temperature and pH) and upload it to the Aquaware cloud API. We\u2019ll be using the Arduino MKR WiFi 1010 microcontroller, equipped with WiFi capabilities, along with specific sensors to measure water parameters."}),"\n",(0,i.jsx)(n.h3,{id:"hardware-and-software-requirements",children:"Hardware and Software Requirements"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Hardware:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Arduino MKR WiFi 1010 or equivalent with WiFi support"}),"\n",(0,i.jsx)(n.li,{children:"DS18B20 Temperature Sensor"}),"\n",(0,i.jsx)(n.li,{children:"pH Sensor (analog output)"}),"\n",(0,i.jsx)(n.li,{children:"Breadboard and jumper wires"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Software:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Arduino IDE or VSCode with PlatformIO"}),"\n",(0,i.jsxs)(n.li,{children:["Libraries: ",(0,i.jsx)(n.code,{children:"WiFiNINA"}),", ",(0,i.jsx)(n.code,{children:"ArduinoHttpClient"}),", ",(0,i.jsx)(n.code,{children:"ArduinoJson"}),", ",(0,i.jsx)(n.code,{children:"OneWire"}),", ",(0,i.jsx)(n.code,{children:"DallasTemperature"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"libraries-used",children:"Libraries Used"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"WiFiNINA"}),": For connecting to WiFi networks."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"ArduinoHttpClient"}),": To send HTTP requests to the Aquaware API."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"ArduinoJson"}),": For handling JSON payloads."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"OneWire and DallasTemperature"}),": For reading temperature data from DS18B20 sensors."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"setting-up-the-environment",children:"Setting Up the Environment"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Install the Arduino IDE (or use VSCode with PlatformIO)."})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Add the required libraries"})," by searching for them in the Library Manager or adding them manually:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"WiFiNINA"}),"\n",(0,i.jsx)(n.li,{children:"ArduinoHttpClient"}),"\n",(0,i.jsx)(n.li,{children:"ArduinoJson"}),"\n",(0,i.jsx)(n.li,{children:"OneWire"}),"\n",(0,i.jsx)(n.li,{children:"DallasTemperature"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"wiring-the-sensors",children:"Wiring the Sensors"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Temperature Sensor (DS18B20):"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Connect the ",(0,i.jsx)(n.strong,{children:"VCC"})," pin to ",(0,i.jsx)(n.strong,{children:"5V"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Connect the ",(0,i.jsx)(n.strong,{children:"GND"})," pin to ",(0,i.jsx)(n.strong,{children:"GND"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Connect the ",(0,i.jsx)(n.strong,{children:"Data"})," pin to ",(0,i.jsx)(n.strong,{children:"Pin 5"})," on the Arduino."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"pH Sensor:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Connect the ",(0,i.jsx)(n.strong,{children:"Signal"})," pin to ",(0,i.jsx)(n.strong,{children:"A0"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Connect ",(0,i.jsx)(n.strong,{children:"VCC"})," to ",(0,i.jsx)(n.strong,{children:"5V"})," and ",(0,i.jsx)(n.strong,{children:"GND"})," to ",(0,i.jsx)(n.strong,{children:"GND"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"initialization",children:"Initialization"}),"\n",(0,i.jsx)(n.p,{children:"The code consists of three main parts: setup, loop, and helper functions for reading sensors and sending data to the server."}),"\n",(0,i.jsx)(n.h3,{id:"wifi-setup",children:"WiFi Setup"}),"\n",(0,i.jsxs)(n.p,{children:["The following lines are used to connect the Arduino to a Wi-Fi network. The credentials are stored in a ",(0,i.jsx)(n.code,{children:"secrets.h"})," file for security purposes."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:'char ssid[] = SECRET_SSID;   // SSID located in secrets.h\r\nchar pass[] = SECRET_PASS;   // Password located in secrets.h\r\nchar email[] = EMAIL;\r\nchar password[] = PASSWORD;\r\n\r\nWiFiSSLClient wifiClient;\r\nHttpClient client = HttpClient(wifiClient, "dev.aquaware.cloud", 443);\n'})}),"\n",(0,i.jsx)(n.h3,{id:"sensor-initialization",children:"Sensor Initialization"}),"\n",(0,i.jsxs)(n.p,{children:["In the ",(0,i.jsx)(n.code,{children:"setup()"})," function, the temperature sensor is initialized, and the board connects to the Wi-Fi network."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:'void setup() {\r\n  delay(10000);\r\n  Serial.begin(9600);\r\n  Serial.println("Setup started...");\r\n\r\n  sensors.begin(); // Initialize temperature sensor\r\n  connectToWiFi(); // Connect to Wi-Fi network\r\n}\r\n\r\nvoid connectToWiFi() {\r\n  Serial.print("Connecting to Wi-Fi...");\r\n  while (WiFi.status() != WL_CONNECTED) {\r\n    WiFi.begin(ssid, pass);\r\n    delay(500);\r\n    Serial.print(".");\r\n  }\r\n  Serial.println(" connected.");\r\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"authentication-handling-in-the-arduino-code",children:"Authentication Handling in the Arduino Code"}),"\n",(0,i.jsxs)(n.p,{children:["To securely communicate with the Aquaware API, the Arduino code implements two important functions for handling authentication: ",(0,i.jsx)(n.code,{children:"login()"})," and ",(0,i.jsx)(n.code,{children:"refreshAccessToken()"}),". These functions ensure that the device can authenticate and maintain access to the API."]}),"\n",(0,i.jsxs)(n.h3,{id:"1-login-getting-access-and-refresh-tokens",children:["1. ",(0,i.jsx)(n.code,{children:"login()"}),": Getting Access and Refresh Tokens"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"login()"})," function sends an HTTP POST request to the API with the user's email and password to obtain access and refresh tokens. These tokens are necessary for authenticating future requests."]}),"\n",(0,i.jsxs)(n.h4,{id:"key-steps-in-the-login-function",children:["Key Steps in the ",(0,i.jsx)(n.code,{children:"login()"})," Function"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Prepare the JSON payload"})," containing the email and password."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Send a POST request"})," to the ",(0,i.jsx)(n.code,{children:"/api/users/login/"})," endpoint."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Check the response status code"})," to determine if the login was successful."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Deserialize the JSON response"})," to extract the access and refresh tokens, which are then stored for later use."]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"code-example",children:"Code Example"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:'void login() {\r\n  String payload = "{"email":"" + String(email) + "","password":"" + String(password) + ""}";\r\n  client.beginRequest();\r\n  client.post("/api/users/login/");\r\n  client.sendHeader("Content-Type", "application/json");\r\n  client.sendHeader("Content-Length", payload.length());\r\n  client.beginBody();\r\n  client.print(payload);\r\n  client.endRequest();\r\n\r\n  int statusCode = client.responseStatusCode();\r\n  String response = client.responseBody();\r\n\r\n  if (statusCode == 202) {\r\n    StaticJsonDocument<202> doc;\r\n    deserializeJson(doc, response);\r\n\r\n    accessToken = doc["access"].as<String>();\r\n    refreshToken = doc["refresh"].as<String>();\r\n\r\n    Serial.println("Login successful.");\r\n  } else {\r\n    Serial.print("Login failed, error: ");\r\n    Serial.println(statusCode);\r\n    Serial.println("Response:");\r\n    Serial.println(response);\r\n  }\r\n}\n'})}),"\n",(0,i.jsxs)(n.h3,{id:"2-refreshaccesstoken-maintaining-an-active-session",children:["2. ",(0,i.jsx)(n.code,{children:"refreshAccessToken()"}),": Maintaining an Active Session"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"refreshAccessToken()"})," function helps keep the connection to the API alive by refreshing the access token before it expires. It uses the refresh token obtained during login."]}),"\n",(0,i.jsxs)(n.h4,{id:"key-steps-in-the-refreshaccesstoken-function",children:["Key Steps in the ",(0,i.jsx)(n.code,{children:"refreshAccessToken()"})," Function"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Send a POST request"})," to the ",(0,i.jsx)(n.code,{children:"/api/users/token/refresh/"})," endpoint with the refresh token."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Check the response status code"})," to ensure that the token refresh was successful."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Update the access token"})," for future authenticated requests."]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"code-example-1",children:"Code Example"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:'bool refreshAccessToken() {\r\n  client.beginRequest();\r\n  client.post("/api/users/token/refresh/");\r\n  client.sendHeader("Content-Type", "application/json");\r\n\r\n  String payload = "{"refresh":"" + refreshToken + ""}";\r\n  client.sendHeader("Content-Length", payload.length());\r\n  client.beginBody();\r\n  client.print(payload);\r\n  client.endRequest();\r\n\r\n  int statusCode = client.responseStatusCode();\r\n  String response = client.responseBody();\r\n\r\n  if (statusCode == 200) {\r\n    StaticJsonDocument<200> doc;\r\n    deserializeJson(doc, response);\r\n\r\n    accessToken = doc["access"].as<String>();\r\n\r\n    Serial.println("Access token refreshed.");\r\n    return true;\r\n  } else {\r\n    Serial.print("Failed to refresh token, error: ");\r\n    Serial.println(statusCode);\r\n    Serial.println("Response:");\r\n    Serial.println(response);\r\n    return false;\r\n  }\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"best-practices-for-authentication",children:"Best Practices for Authentication"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Securely Store Tokens:"})," Always store the access and refresh tokens securely to prevent unauthorized access."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Regularly Refresh Tokens:"})," Refresh the access token periodically to avoid interruptions in data transmission."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Handle Errors Gracefully:"})," Implement robust error handling to account for failed login attempts or token refresh operations."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Use HTTPS:"})," Always use secure connections (HTTPS) when transmitting sensitive data like login credentials or tokens."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"sending-sensor-data-to-the-aquaware-api",children:"Sending Sensor Data to the Aquaware API"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"sendData()"})," function in the Arduino code is responsible for transmitting the collected water quality measurements (temperature and pH) to the Aquaware cloud API. It constructs an HTTP POST request, which includes the data as a JSON payload, and sends it to the server for storage and further processing."]}),"\n",(0,i.jsxs)(n.h3,{id:"breakdown-of-the-senddata-function",children:["Breakdown of the ",(0,i.jsx)(n.code,{children:"sendData()"})," Function"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Prepare the HTTP Request:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The function uses the ",(0,i.jsx)(n.code,{children:"HttpClient"})," library to start a new HTTP request. The request is sent to the endpoint ",(0,i.jsx)(n.code,{children:"/api/measurements/add/3/"}),", which is responsible for accepting measurement data. ",(0,i.jsxs)(n.strong,{children:["Remember to change the ",3," to your environment-id"]})]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"Content-Type"})," header is set to ",(0,i.jsx)(n.code,{children:"application/json"})," to indicate that the payload is in JSON format."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"Authorization"})," header is used to include the access token, allowing the server to authenticate the request."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Create the JSON Payload:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The payload is a JSON-formatted string that includes the temperature, pH, and TDS values."}),"\n",(0,i.jsxs)(n.li,{children:["Example: ",(0,i.jsx)(n.code,{children:'{"Temperature":25.0,"PH":7.4}'})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Send the Request:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"client.beginBody()"})," function is used to start sending the body of the request. The JSON payload is then transmitted, and the request is completed using ",(0,i.jsx)(n.code,{children:"client.endRequest()"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Handle the Server Response:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The function checks the HTTP status code returned by the server. A status code of ",(0,i.jsx)(n.code,{children:"201"})," indicates that the data was successfully received and stored."]}),"\n",(0,i.jsx)(n.li,{children:"If the data is not successfully sent, the function outputs the error code and server response for debugging."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"code-example-2",children:"Code Example"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:'bool sendData(float temp, float ph, float tds) {\r\n  client.beginRequest();\r\n  client.post("/api/measurements/add/3/");\r\n  client.sendHeader("Content-Type", "application/json");\r\n  client.sendHeader("Authorization", "Bearer " + accessToken);\r\n\r\n  String payload = "{"Temperature":" + String(temp) + ","PH":" + String(ph) + ","TDS":" + String(tds) + "}";\r\n  client.sendHeader("Content-Length", payload.length());\r\n  client.beginBody();\r\n  client.print(payload);\r\n  client.endRequest();\r\n\r\n  int statusCode = client.responseStatusCode();\r\n  String response = client.responseBody();\r\n\r\n  if (statusCode == 201) {\r\n    Serial.println("Data sent successfully.");\r\n    return true;\r\n  } else {\r\n    Serial.print("Failed to send data, error: ");\r\n    Serial.println(statusCode);\r\n    Serial.println("Response:");\r\n    Serial.println(response);\r\n    return false;\r\n  }\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"best-practices-for-data-transmission",children:"Best Practices for Data Transmission"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Check the Status Code:"})," Always verify the server's response to ensure the data was received correctly."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Log Data Locally Before Sending:"})," Keep a local copy of the data in case the network transmission fails, allowing for a retry mechanism."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Use Secure Endpoints:"})," Always use HTTPS to ensure that the data is transmitted securely."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Avoid Hardcoding API Endpoints:"})," Consider using configuration files or variables for endpoints to facilitate easier maintenance."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsxs)(n.p,{children:["If the server does not return a ",(0,i.jsx)(n.code,{children:"201"})," status code, the function outputs the error for debugging purposes. The response should be carefully logged to identify potential issues, such as authentication failures or server errors."]}),"\n",(0,i.jsx)(n.h2,{id:"main-loop-explanation-in-the-arduino-code",children:"Main Loop Explanation in the Arduino Code"}),"\n",(0,i.jsxs)(n.p,{children:["In the Arduino sketch, the ",(0,i.jsx)(n.code,{children:"loop()"})," function continuously executes, checking conditions and performing tasks as required. This example uses a timer-based approach to read sensor data and send it to the server. While polling is a technique where the code constantly checks for a condition or data change, using a timer allows for more efficient processing by executing tasks at specified intervals. Here, the timer is set to 30 minutes (for ",(0,i.jsx)(n.strong,{children:"Advanced"})," and ",(0,i.jsx)(n.strong,{children:"Premium Plans"}),"), and the loop includes specific logic to handle WiFi connectivity and token management."]}),"\n",(0,i.jsx)(n.h3,{id:"polling-vs-timer-based-approach",children:"Polling vs. Timer-Based Approach"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Polling:"})," Involves continuously checking the state of a condition or sensor. It can consume more power and resources because the code runs repeatedly without pauses."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Timer-Based Approach:"})," Executes specific code only at defined intervals, which helps conserve power and reduces the amount of redundant processing. For this tutorial, a timer is used to execute the data reading and sending process every 30 minutes."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"timer-configuration-in-the-loop",children:"Timer Configuration in the Loop"}),"\n",(0,i.jsx)(n.p,{children:"The timer is set up to check every 30 minutes (1,800,000 milliseconds). For the free Hobby plan, the interval would be set to 2 hours (7,200,000 milliseconds). When the timer condition is met, the code performs the following actions:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Check the WiFi Status:"})," The code verifies if the device is still connected to WiFi. If not, it attempts to reconnect. This ensures reliable data transmission."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Refresh the Access Token:"})," The access token is refreshed before sending data to maintain an active session with the server."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Sensor Data Collection:"})," The temperature and pH readings are taken using smoothing techniques to reduce the impact of outliers."]}),"\n"]}),"\n",(0,i.jsxs)(n.h3,{id:"code-example-for-the-loop-function",children:["Code Example for the ",(0,i.jsx)(n.code,{children:"loop()"})," Function"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:'void loop() {\r\n  // Check if the timer interval has passed\r\n  if (millis() > timeOut + timer) {\r\n    timer = millis();\r\n    Serial.println("Timer triggered...");\r\n\r\n    // Check Wi-Fi connection\r\n    if (WiFi.status() != WL_CONNECTED) {\r\n      Serial.println("Wi-Fi not connected. Reconnecting...");\r\n      connectToWiFi();\r\n    } else {\r\n      Serial.println("Wi-Fi connected.");\r\n    }\r\n\r\n    // Refresh the access token if needed\r\n    Serial.println("Refreshing access token...");\r\n    if (!refreshAccessToken()) {\r\n      Serial.println("Failed to refresh access token, re-logging...");\r\n      login();\r\n    }\r\n\r\n    // Start reading the sensors\r\n    sensors.requestTemperatures();\r\n    for (int i = 0; i < READINGSCOUNT; i++) {\r\n      readPH(i);  // Read pH value\r\n      readTemp(i); // Read temperature value\r\n    }\r\n\r\n    // Calculate the median values for stable measurements\r\n    float medianTemp = getMedianNum(temp, READINGSCOUNT);\r\n    float medianPH = mapFloat(getMedianNum(ph, READINGSCOUNT), 260.0, 460.0, 4.0, 9.18);\r\n\r\n    // Output the measurements\r\n    Serial.println("----------------------------------------------------------");\r\n    Serial.print("PH: ");\r\n    Serial.println(medianPH);\r\n    Serial.print("Temp: ");\r\n    Serial.print(medianTemp);\r\n    Serial.println(" \xb0C");\r\n\r\n    // Send the data to the server\r\n    Serial.println("Sending data to the server...");\r\n    bool success = sendData(medianTemp, medianPH, 0); // TDS omitted for brevity\r\n\r\n    if (success) {\r\n      Serial.println("Data successfully sent to the server.");\r\n    } else {\r\n      Serial.println("Failed to send data to the server.");\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"explanation-of-sensor-reading-functions",children:"Explanation of Sensor Reading Functions"}),"\n",(0,i.jsxs)(n.h4,{id:"1-reading-temperature-readtemp",children:["1. Reading Temperature (",(0,i.jsx)(n.code,{children:"readTemp()"}),")"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"readTemp()"})," function retrieves temperature data from the DS18B20 sensor. It stores the values in an array to apply smoothing and reduce the impact of outliers."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:"void readTemp(int index) {\r\n  float temp_Value = sensors.getTempCByIndex(0);\r\n  temp[index] = temp_Value;\r\n}\n"})}),"\n",(0,i.jsxs)(n.h4,{id:"2-reading-ph-readph",children:["2. Reading pH (",(0,i.jsx)(n.code,{children:"readPH()"}),")"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"readPH()"})," function captures the pH value from the analog pin. The values are stored in an array for further processing to ensure that any outlier readings do not significantly affect the final result."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:"void readPH(int index) {\r\n  float pH_Value = analogRead(PH_PIN);\r\n  ph[index] = pH_Value;\r\n}\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"handling-readingscount",children:["Handling ",(0,i.jsx)(n.code,{children:"READINGSCOUNT"})]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"READINGSCOUNT"})," parameter determines the number of sensor readings taken for each measurement cycle. By taking multiple readings and computing the median, the effect of outliers is minimized, providing more accurate sensor data. In this code, the readings are stored in arrays (",(0,i.jsx)(n.code,{children:"temp"})," for temperature and ",(0,i.jsx)(n.code,{children:"ph"})," for pH), and the median of these values is used as the final measurement."]}),"\n",(0,i.jsx)(n.h3,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Use Median Filtering:"})," Helps stabilize sensor readings by reducing the influence of outliers."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Check Connectivity Before Data Transmission:"})," Ensures that data is only sent when the device is connected to the network."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Manage Timer Intervals Based on Plan:"})," Adjust the timer interval based on the subscription plan to comply with data transmission frequency limits."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"complete-code",children:"Complete Code"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:'#include <WiFiNINA.h>\r\n#include <ArduinoHttpClient.h>\r\n#include <ArduinoJson.h>\r\n#include "secrets.h"\r\n#include <OneWire.h>\r\n#include <DallasTemperature.h>\r\n\r\n// ---WiFi settings---\r\nchar ssid[] = SECRET_SSID;   // SSID located in secrets.h\r\nchar pass[] = SECRET_PASS;   // Password located in secrets.h\r\nchar email[] = EMAIL;\r\nchar password[] = PASSWORD;\r\n\r\n// WiFi and client setup\r\nWiFiSSLClient wifiClient;\r\nHttpClient client = HttpClient(wifiClient, "dev.aquaware.cloud", 443);\r\n\r\n#define VREF 3.3              // Analog reference voltage of the ADC\r\n#define READINGSCOUNT 100     // The amount of reading to calculate the average from\r\n\r\n// ---PH---\r\n#define PH_PIN A0\r\n\r\n// ---Temp---\r\n#define TEMP_PIN 5\r\nOneWire oneWire(TEMP_PIN);\r\nDallasTemperature sensors(&oneWire);\r\n\r\n// ---TDS---\r\n#define TDS_PIN A2\r\n#define SCOUNT  1           // sum of sample points\r\nfloat analogBuffer[SCOUNT];     // store the analog value in the array, read from ADC\r\nfloat analogBufferTemp[SCOUNT];\r\nint analogBufferIndex = 0;\r\nint copyIndex = 0;\r\nfloat averageVoltage = 0;\r\nfloat temperature = 21;\r\nfloat tdsValue = 0;\r\n\r\n// Lists of input to smoothen the result\r\nfloat tds[READINGSCOUNT];\r\nfloat ph[READINGSCOUNT];\r\nfloat temp[READINGSCOUNT];\r\n\r\n// Timer to calculate the interval to read data and send them\r\nlong timer = 0;\r\nlong timeOut = 1800000; // 30 minutes in milliseconds\r\n\r\nString accessToken = "";\r\nString refreshToken = "";\r\n\r\n// This method is called once when the Arduino board is powered on or reset.\r\nvoid setup() {\r\n  delay(10000);\r\n  // Initialize serial communication\r\n  Serial.begin(9600);\r\n  Serial.println("Setup started...");\r\n\r\n  // Initialize temperature sensor\r\n  sensors.begin();\r\n  Serial.println("Temperature sensor initialized.");\r\n\r\n  // Connect to Wi-Fi\r\n  connectToWiFi();\r\n  Serial.println("Wi-Fi setup completed.");\r\n}\r\n\r\n// This method runs repeatedly every tick.\r\nvoid loop() {\r\n\r\n  if (millis() > timeOut + timer) {\r\n    timer = millis();\r\n    Serial.println("Timer triggered...");\r\n\r\n    // Check Wi-Fi connection\r\n    if (WiFi.status() != WL_CONNECTED) {\r\n      Serial.println("Wi-Fi not connected. Reconnecting...");\r\n      connectToWiFi();\r\n    } else {\r\n      Serial.println("Wi-Fi connected.");\r\n    }\r\n\r\n    // Login to get the access and refresh tokens if not already available\r\n    if (accessToken == "") {\r\n      Serial.println("No access token found. Logging in...");\r\n      login();\r\n    }\r\n\r\n    // Start reading the sensors\r\n    sensors.requestTemperatures();\r\n    for (int i = 0; i < READINGSCOUNT; i++) {\r\n      readPH(i);\r\n      readTDS(i);\r\n      readTemp(i);\r\n    }\r\n\r\n    // Prepare data to send\r\n    float medianTemp = getMedianNum(temp, READINGSCOUNT);\r\n    float medianPH = mapFloat(getMedianNum(ph, READINGSCOUNT), 260.0, 460.0, 4.0, 9.18);\r\n    float medianTDS = getMedianNum(tds, READINGSCOUNT);\r\n\r\n    // Serial output for debugging\r\n    Serial.println("----------------------------------------------------------");\r\n    Serial.print("TDS: ");\r\n    Serial.print(medianTDS);\r\n    Serial.println(" ppm");\r\n    Serial.print("PH: ");\r\n    Serial.println(medianPH);\r\n    Serial.print("Temp: ");\r\n    Serial.print(medianTemp);\r\n    Serial.println(" \xb0C");\r\n\r\n    // Refresh the access token if needed\r\n    Serial.println("Refreshing access token...");\r\n    if (!refreshAccessToken()) {\r\n      Serial.println("Failed to refresh access token, re-logging...");\r\n      login();\r\n    }\r\n\r\n    // Send the data to the server\r\n    Serial.println("Sending data to the server...");\r\n    bool success = sendData(medianTemp, medianPH, medianTDS);\r\n\r\n    if (success) {\r\n      Serial.println("Data successfully sent to the server.");\r\n    } else {\r\n      Serial.println("Failed to send data to the server.");\r\n    }\r\n  }\r\n}\r\n\r\n// Connect to Wi-Fi\r\nvoid connectToWiFi() {\r\n  Serial.print("Connecting to Wi-Fi...");\r\n  while (WiFi.status() != WL_CONNECTED) {\r\n    WiFi.begin(ssid, pass);\r\n    delay(500);\r\n    Serial.print(".");\r\n  }\r\n  Serial.println(" connected.");\r\n}\r\n\r\n// Login to get access and refresh tokens\r\nvoid login() {\r\n  String payload = "{\\"email\\":\\"" + String(email) + "\\",\\"password\\":\\"" + String(password) + "\\"}";\r\n  client.beginRequest();\r\n  client.post("/api/users/login/");\r\n  client.sendHeader("Content-Type", "application/json");\r\n  client.sendHeader("Content-Length", payload.length());\r\n  client.beginBody();\r\n  client.print(payload);\r\n  client.endRequest();\r\n\r\n  int statusCode = client.responseStatusCode();\r\n  String response = client.responseBody();\r\n\r\n  if (statusCode == 202) {\r\n    StaticJsonDocument<202> doc;\r\n    deserializeJson(doc, response);\r\n\r\n    accessToken = doc["access"].as<String>();\r\n    refreshToken = doc["refresh"].as<String>();\r\n\r\n    Serial.println("Login successful.");\r\n  } else {\r\n    Serial.print("Login failed, error: ");\r\n    Serial.println(statusCode);\r\n    Serial.println("Response:");\r\n    Serial.println(response);\r\n  }\r\n}\r\n\r\n// Refresh the access token\r\nbool refreshAccessToken() {\r\n  client.beginRequest();\r\n  client.post("/api/users/token/refresh/");\r\n  client.sendHeader("Content-Type", "application/json");\r\n\r\n  String payload = "{\\"refresh\\":\\"" + refreshToken + "\\"}";\r\n  client.sendHeader("Content-Length", payload.length());\r\n  client.beginBody();\r\n  client.print(payload);\r\n  client.endRequest();\r\n\r\n  int statusCode = client.responseStatusCode();\r\n  String response = client.responseBody();\r\n\r\n  if (statusCode == 200) {\r\n    StaticJsonDocument<200> doc;\r\n    deserializeJson(doc, response);\r\n\r\n    accessToken = doc["access"].as<String>();\r\n\r\n    Serial.println("Access token refreshed.");\r\n    return true;\r\n  } else {\r\n    Serial.print("Failed to refresh token, error: ");\r\n    Serial.println(statusCode);\r\n    Serial.println("Response:");\r\n    Serial.println(response);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Send data to the server\r\nbool sendData(float temp, float ph, float tds) {\r\n  client.beginRequest();\r\n  client.post("/api/measurements/add/3/");\r\n  client.sendHeader("Content-Type", "application/json");\r\n  client.sendHeader("Authorization", "Bearer " + accessToken);\r\n\r\n  String payload = "{\\"Temperature\\":" + String(temp) + ",\\"PH\\":" + String(ph) + ",\\"TDS\\":" + String(tds) + "}";\r\n  client.sendHeader("Content-Length", payload.length());\r\n  client.beginBody();\r\n  client.print(payload);\r\n  client.endRequest();\r\n\r\n  int statusCode = client.responseStatusCode();\r\n  String response = client.responseBody();\r\n\r\n  if (statusCode == 201) {\r\n    Serial.println("Data sent successfully.");\r\n    return true;\r\n  } else {\r\n    Serial.print("Failed to send data, error: ");\r\n    Serial.println(statusCode);\r\n    Serial.println("Response:");\r\n    Serial.println(response);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Read PH per analog reading and write it into a list to smoothen measurement data\r\nvoid readPH(int index) {\r\n  float pH_Value = analogRead(PH_PIN);\r\n  ph[index] = pH_Value;\r\n}\r\n\r\n// Read temperature via OneWire library and write it into a list to smoothen measurement data\r\nvoid readTemp(int index) {\r\n  float temp_Value = sensors.getTempCByIndex(0);\r\n  temp[index] = temp_Value;\r\n}\r\n\r\n// Read TDS value and apply some compensation algorithm\r\nvoid readTDS(int index) {\r\n  static unsigned long analogSampleTimepoint = millis();\r\n  if(millis()-analogSampleTimepoint > 40U){\r\n    analogSampleTimepoint = millis();\r\n    analogBuffer[analogBufferIndex] = analogRead(TDS_PIN);\r\n    analogBufferIndex++;\r\n    if(analogBufferIndex == SCOUNT){\r\n      analogBufferIndex = 0;\r\n    }\r\n  }\r\n  static unsigned long printTimepoint = millis();\r\n  if(millis()-printTimepoint > 800U){\r\n    printTimepoint = millis();\r\n    for(copyIndex=0; copyIndex<SCOUNT; copyIndex++){\r\n      analogBufferTemp[copyIndex] = analogBuffer[copyIndex];\r\n      averageVoltage = getMedianNum(analogBufferTemp,SCOUNT) * (float)VREF / 1024.0;\r\n\r\n      float compensationCoefficient = 1.0+0.02*(temperature-25.0);\r\n      float compensationVoltage = averageVoltage/compensationCoefficient;\r\n\r\n      tdsValue = (133.42*compensationVoltage*compensationVoltage*compensationVoltage - 255.86*compensationVoltage*compensationVoltage + 857.39*compensationVoltage)*0.5;\r\n    }\r\n  }\r\n  tds[index] = tdsValue;\r\n}\r\n\r\n// Get a stable value from an array of readings.\r\nint getMedianNum(float bArray[], int iFilterLen) {\r\n  int bTab[iFilterLen];\r\n  for (byte i = 0; i < iFilterLen; i++)\r\n    bTab[i] = bArray[i];\r\n\r\n  int i, j, bTemp;\r\n  for (j = 0; j < iFilterLen - 1; j++) {\r\n    for (i = 0; i < iFilterLen - j - 1; i++) {\r\n      if (bTab[i] > bTab[i + 1]) {\r\n        bTemp = bTab[i];\r\n        bTab[i] = bTab[i + 1];\r\n        bTab[i + 1] = bTemp;\r\n      }\r\n    }\r\n  }\r\n\r\n  if ((iFilterLen & 1) > 0) {\r\n    bTemp = bTab[(iFilterLen - 1) / 2];\r\n  } else {\r\n    bTemp = (bTab[iFilterLen / 2] + bTab[iFilterLen / 2 - 1]) / 2;\r\n  }\r\n\r\n  return bTemp;\r\n}\r\n\r\nfloat mapFloat(float x, float in_min, float in_max, float out_min, float out_max) {\r\n  return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;\r\n}\r\n\n'})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>o});var i=r(6540);const t={},s=i.createContext(t);function a(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);